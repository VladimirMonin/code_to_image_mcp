@startuml
' Тестовая диаграмма активности для интеграционного теста

start
:Получить HTTP запрос;

if (Токен авторизации валиден?) then (да)
  :Извлечь user_id из токена;
  
  if (Корзина не пустая?) then (да)
    :Рассчитать стоимость заказа <<Core>>;
    
    fork
      :Валидировать товары;
    fork again
      :Проверить наличие на складе;
    fork again
      :Применить промокод (если есть);
    end fork
    
    :Создать заказ в БД <<Infrastructure>>;
    
    if (Оплата картой?) then (да)
      :Обработать оплату <<Core>>;
      
      if (Платёж успешен?) then (да)
        :Подтвердить заказ;
        :Отправить email <<Infrastructure>>;
        :Вернуть order_id;
        stop
      else (нет)
        :Откатить транзакцию;
        :Вернуть ошибку оплаты;
        stop
      endif
    else (нет)
      :Зарезервировать заказ;
      :Вернуть invoice_id;
      stop
    endif
  else (нет)
    :Вернуть HTTP 400;
    :Ошибка "Корзина пуста";
    stop
  endif
else (нет)
  :Вернуть HTTP 401;
  :Ошибка "Unauthorized";
  stop
endif

@enduml
