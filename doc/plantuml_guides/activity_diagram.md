# Activity Diagram Guide

<!-- BRIEF_START -->
## ⚠️ КРИТИЧЕСКИ ВАЖНО ДЛЯ AI МОДЕЛЕЙ

**ЗАПРЕЩЕНО ИСПОЛЬЗОВАТЬ:**

- ❌ `!theme` или `!include` директивы
- ❌ `skinparam` настройки
- ❌ Жёстко прописанные цвета (#RRGGBB)

**ПРАВИЛЬНЫЙ ПОДХОД:**

- ✅ НЕ используйте стилизацию в activity диаграммах
- ✅ Передавайте тему через параметр `theme_name`
- ✅ Генерируйте ЧИСТЫЙ PlantUML код без стилизации!

---

**Синтаксис базовых элементов:**

```plantuml
start
:Действие;
stop
```

**Условия:**

```plantuml
if (условие?) then (да)
    :Действие A;
else (нет)
    :Действие B;
endif
```

**Циклы:**

```plantuml
while (условие?) is (да)
    :Повторяющееся действие;
endwhile (нет)
```

**Параллельность:**

```plantuml
fork
    :Действие A;
fork again
    :Действие B;
end fork
```
<!-- BRIEF_END -->

<!-- DETAILED_START -->
## Примеры использования

### Простой процесс

```plantuml
@startuml
start
:Получить запрос;
:Валидировать данные;
:Обработать запрос;
:Отправить ответ;
stop
@enduml
```

### Условная логика

```plantuml
@startuml
start
:Получить заказ;

if (Товар в наличии?) then (да)
    :Зарезервировать товар;
    :Создать накладную;
else (нет)
    :Уведомить клиента;
    :Добавить в лист ожидания;
endif

:Отправить подтверждение;
stop
@enduml
```

### Множественный выбор

```plantuml
@startuml
start
:Получить платёж;

switch (Тип платежа?)
case (Карта)
    :Обработать через банк;
case (PayPal)
    :Обработать через PayPal API;
case (Криптовалюта)
    :Обработать через блокчейн;
endswitch

:Подтвердить платёж;
stop
@enduml
```

### Цикл обработки

```plantuml
@startuml
start
:Получить список задач;

while (Есть необработанные задачи?) is (да)
    :Взять следующую задачу;
    :Обработать задачу;
    :Обновить статус;
endwhile (нет)

:Отправить отчёт;
stop
@enduml
```

### Параллельная обработка

```plantuml
@startuml
start
:Получить заказ;

fork
    :Проверить оплату;
fork again
    :Проверить наличие товара;
fork again
    :Проверить адрес доставки;
end fork

if (Все проверки пройдены?) then (да)
    :Подтвердить заказ;
else (нет)
    :Отменить заказ;
endif

stop
@enduml
```

### Разделение на зоны ответственности (swimlanes)

```plantuml
@startuml
|Клиент|
start
:Создать заказ;

|Система|
:Валидировать заказ;
:Рассчитать стоимость;

|Склад|
:Проверить наличие;
:Зарезервировать товар;

|Система|
:Сформировать счёт;

|Клиент|
:Оплатить заказ;

|Система|
:Подтвердить оплату;
stop
@enduml
```

## Частые ошибки

1. **Забыли start/stop:**
   - Диаграмма должна начинаться с `start`
   - И заканчиваться `stop` или `end`

2. **Забыли точку с запятой:**
   - ❌ `:Действие`
   - ✅ `:Действие;`

3. **Неправильный синтаксис if:**
   - ❌ `if условие`
   - ✅ `if (условие?) then (да)`

4. **Незакрытые блоки:**
   - `if` требует `endif`
   - `while` требует `endwhile`
   - `fork` требует `end fork`

## Элементы диаграммы

| Элемент | Описание |
|---------|----------|
| `start` | Начало процесса (чёрный кружок) |
| `stop` | Конец процесса (чёрный кружок в кольце) |
| `end` | Альтернативный конец |
| `:Текст;` | Действие (прямоугольник со скруглёнными краями) |
| `if/else/endif` | Условный переход (ромб) |
| `switch/case` | Множественный выбор |
| `while/endwhile` | Цикл с условием |
| `repeat/repeatwhile` | Цикл do-while |
| `fork/end fork` | Параллельное выполнение |
| `|Swimlane|` | Разделение по зонам ответственности |

## Styling & Themes

⚠️ **КРИТИЧЕСКИ ВАЖНО ДЛЯ AI МОДЕЛЕЙ:**

**ЗАПРЕЩЕНО:**

- ❌ Использовать `!theme` или `!include` директивы
- ❌ Жёстко прописывать цвета (например: `skinparam activityBackgroundColor green`)
- ❌ Переопределять стили через `skinparam` в diagram_code

**ПРАВИЛЬНЫЙ ПОДХОД:**

- ✅ ВСЕГДА вызывайте `list_plantuml_themes` перед генерацией диаграммы
- ✅ Передавайте выбранную тему через параметр `theme_name`
- ✅ Доверьте цвета и стили теме — ваша задача логика процесса
- ✅ Используйте swimlanes для визуального разделения ответственности

**Пример правильного использования:**

```plantuml
@startuml
start
:Получить запрос;
if (Валидация?) then (успех)
    :Обработать данные;
    :Сохранить в БД;
else (ошибка)
    :Вернуть 400 Bad Request;
endif
stop
@enduml
```

## Production-Ready Example

**Это полноценный пример из реальных тестов проекта (`tests/assets/activity_diagram.puml`).**

Демонстрирует сложный бизнес-процесс создания заказа с условиями, параллельностью и использованием стереотипов:

```plantuml
@startuml
' Тестовая диаграмма активности для интеграционного теста

start
:Получить HTTP запрос;

if (Токен авторизации валиден?) then (да)
  :Извлечь user_id из токена;
  
  if (Корзина не пустая?) then (да)
    :Рассчитать стоимость заказа <<Core>>;
    
    fork
      :Валидировать товары;
    fork again
      :Проверить наличие на складе;
    fork again
      :Применить промокод (если есть);
    end fork
    
    :Создать заказ в БД <<Infrastructure>>;
    
    if (Оплата картой?) then (да)
      :Обработать оплату <<Core>>;
      
      if (Платёж успешен?) then (да)
        :Подтвердить заказ;
        :Отправить email <<Infrastructure>>;
        :Вернуть order_id;
        stop
      else (нет)
        :Откатить транзакцию;
        :Вернуть ошибку оплаты;
        stop
      endif
    else (нет)
      :Зарезервировать заказ;
      :Вернуть invoice_id;
      stop
    endif
  else (нет)
    :Вернуть HTTP 400;
    :Ошибка "Корзина пуста";
    stop
  endif
else (нет)
  :Вернуть HTTP 401;
  :Ошибка "Unauthorized";
  stop
endif

@enduml
```

**Ключевые моменты:**

- ✅ НЕТ директив !theme, !include, skinparam
- ✅ НЕТ жёстко прописанных цветов
- ✅ Использование стереотипов для обозначения слоёв (<<Core>>, <<Infrastructure>>)
- ✅ Правильное использование fork/end fork для параллельности
- ✅ Множественные условные переходы с разными исходами
- ✅ Чистый PlantUML код, готовый к использованию с любой темой

<!-- DETAILED_END -->
