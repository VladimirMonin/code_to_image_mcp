# ๐๏ธ ะััะธัะตะบัััะฐ ะฟัะพะตะบัะฐ Code to Image MCP

## ะะฑะทะพั

ะัะพะตะบั ัะพััะพะธั ะธะท ะดะฒัั ะพัะฝะพะฒะฝัั ะฟะพะดัะธััะตะผ:

1. **Code Screenshot Engine** โ ะะตะฝะตัะฐัะธั ัะบัะธะฝัะพัะพะฒ ะบะพะดะฐ ัะตัะตะท Pygments + Pillow
2. **PlantUML Diagram Renderer** โ ะะตะฝะดะตัะธะฝะณ UML ะดะธะฐะณัะฐะผะผ ัะตัะตะท Java + PlantUML JAR

---

## ะกัััะบัััะฐ ะฟะฐะบะตัะฐ

```
src/
โโโ code_to_image.py      # ะะตะฝะตัะฐัะธั ัะบัะธะฝัะพัะพะฒ ะบะพะดะฐ
โโโ diagram_renderer.py   # PlantUML ัะตะฝะดะตัะธะฝะณ
โโโ font_manager.py       # ะฃะฟัะฐะฒะปะตะฝะธะต TTF ััะธััะฐะผะธ
โโโ font_initializer.py   # ะะฝัะตะบัะธั ััะธััะพะฒ ะฒ JRE
โโโ image_utils.py        # ะฃัะธะปะธัั ะพะฑัะฐะฑะพัะบะธ ะธะทะพะฑัะฐะถะตะฝะธะน
โโโ guide_manager.py      # ะะตะฝะตะดะถะตั PlantUML ะณะฐะนะดะพะฒ
```

---

## 1. Code Screenshot Engine

### ะขะตัะฝะพะปะพะณะธัะตัะบะธะน ััะตะบ

- **Pygments** โ ะะตะบัะตั ะธ ะฟะพะดัะฒะตัะบะฐ ัะธะฝัะฐะบัะธัะฐ
- **Pillow (PIL)** โ ะะตะฝะตัะฐัะธั PNG ะธะท ัะพัะผะฐัะธัะพะฒะฐะฝะฝะพะณะพ ัะตะบััะฐ
- **ImageMagick-like flow** โ ะะตะฝะดะตั โ PIL Image โ ะกะพััะฐะฝะตะฝะธะต

### ะััะธัะตะบัััะฝัะน ะฟะฐััะตัะฝ

```
User Request
    โ
code_to_image.create_code_image()
    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. Pygments Lexer              โ โ ะะฐััะธะฝะณ ะบะพะดะฐ ะฟะพ ัะทัะบั
โ 2. Pygments Style              โ โ ะัะฑะพั ัะฒะตัะพะฒะพะน ััะตะผั
โ 3. ImageFormatter              โ โ ะะตะฝะดะตั ะฒ ะฑะฐะนัั PNG
โ 4. PIL Image.open()            โ โ ะะฐะณััะทะบะฐ ะฒ ะฟะฐะผััั
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
image_utils.save_image()
    โ
PNG/WEBP/JPEG ัะฐะนะป
```

### ะะปััะตะฒัะต ะพัะพะฑะตะฝะฝะพััะธ

#### DPI-ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต

```python
# ะะฐะทะผะตั ััะธััะฐ ะธ ะพััััะฟั ัะผะฝะพะถะฐัััั ะฝะฐ scale_factor
scaled_font_size = int(font_size * scale_factor)  # 18 * 3.0 = 54
scaled_pad = int(pad * scale_factor)              # 25 * 3.0 = 75
```

**ะะตะทัะปััะฐั:** ะะทะพะฑัะฐะถะตะฝะธะต 3840ร2160 ะฒะผะตััะพ 1280ร720 (4K ready).

#### ะะฐััะพะผะฝัะต ััะธััั

```python
font_path = get_font_path("JetBrainsMono")
# โ "C:/PY/code_to_image_mcp/asset/fonts/JetBrainsMono-Regular.ttf"

formatter = ImageFormatter(
    font_name=font_path,  # ะััั ะบ TTF, ะะ ะธะผั ััะธััะฐ!
    ...
)
```

**ะะฐะถะฝะพ:** Pygments ััะตะฑัะตั **ะฐะฑัะพะปััะฝัะน ะฟััั** ะบ TTF ัะฐะนะปั, ะฐ ะฝะต ะธะผั ััะธััะฐ ะธะท ัะธััะตะผั.

---

## 2. PlantUML Diagram Renderer

### ะขะตัะฝะพะปะพะณะธัะตัะบะธะน ััะตะบ

- **Java JRE** โ ะะบััะถะตะฝะธะต ะดะปั ะทะฐะฟััะบะฐ PlantUML
- **PlantUML JAR** โ ะะฒะธะถะพะบ ัะตะฝะดะตัะธะฝะณะฐ (`asset/bins/plantuml.jar`)
- **Subprocess** โ ะะทะฐะธะผะพะดะตะนััะฒะธะต Python โ Java ัะตัะตะท stdin/stdout
- **Pillow** โ ะะฑัะฐะฑะพัะบะฐ ัะตะทัะปััะฐัะฐ (PNG ะธะท ะฑะฐะนัะพะฒ)

### ะััะธัะตะบัััะฝัะน ะฟะฐััะตัะฝ

```
User Request
    โ
diagram_renderer.render_diagram_to_image()
    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. ะะฝะธัะธะฐะปะธะทะฐัะธั ััะธััะพะฒ (ะพะดะธะฝ ัะฐะท)    โ
โ    font_initializer.ensure_fonts_initialized()
โ                                         โ
โ 2. ะะพะดะณะพัะพะฒะบะฐ ะบะพะดะฐ ะดะธะฐะณัะฐะผะผั           โ
โ    _prepare_diagram_code()             โ
โ    โ ะััะฐะฒะบะฐ !include ัะตะผั             โ
โ    โ ะะพะฑะฐะฒะปะตะฝะธะต !pragma layout smetana โ
โ                                         โ
โ 3. ะะฐะฟััะบ Java ะฟัะพัะตััะฐ                โ
โ    subprocess.run([                    โ
โ      "java", "-jar", "plantuml.jar",   โ
โ      "-pipe", "-tpng", ...             โ
โ    ], input=diagram_code)              โ
โ                                         โ
โ 4. ะะฑัะฐะฑะพัะบะฐ ัะตะทัะปััะฐัะฐ                โ
โ    - Stderr โ ะัะพะฒะตัะบะฐ ะพัะธะฑะพะบ          โ
โ    - Stdout โ PNG ะฑะฐะนัั                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ
image_utils.load_image_from_bytes()
    โ
PIL Image ะพะฑัะตะบั
```

### ะัะธัะธัะตัะบะฐั ัะธัะฐ: ะะฝัะตะบัะธั ััะธััะพะฒ ะฒ JRE

PlantUML ะธัะฟะพะปัะทัะตั Java ะดะปั ัะตะฝะดะตัะธะฝะณะฐ ัะตะบััะฐ. ะงัะพะฑั **ะบะฐััะพะผะฝัะต ััะธััั** (JetBrains Mono, Fira Code) ัะฐะฑะพัะฐะปะธ, ะธั ะฝัะถะฝะพ ัะบะพะฟะธัะพะฒะฐัั ะฒ ะดะธัะตะบัะพัะธั ััะธััะพะฒ JRE.

#### ะัะพัะตัั ะธะฝะธัะธะฐะปะธะทะฐัะธะธ

```
font_initializer.ensure_fonts_initialized()
    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. ะัะพะฒะตัะบะฐ ะผะฐัะบะตัะฐ                   โ
โ    ะคะฐะนะป: .fonts_installed.json        โ
โ    ะกะพะดะตัะถะธั: ะฟััั ะบ JRE, ัะฟะธัะพะบ ััะธััะพะฒโ
โ                                        โ
โ 2. ะัะปะธ ะผะฐัะบะตัะฐ ะฝะตั:                  โ
โ    ะฐ) ะะฐะนัะธ Java Home                 โ
โ       java -XshowSettings:properties  โ
โ    ะฑ) ะะฐะนัะธ lib/fonts ะฒ JRE           โ
โ    ะฒ) ะกะบะพะฟะธัะพะฒะฐัั *.ttf ะธะท asset/fontsโ
โ    ะณ) ะกะพะทะดะฐัั ะผะฐัะบะตั                  โ
โ                                        โ
โ 3. ะัะปะธ ะผะฐัะบะตั ะตััั:                  โ
โ    โ ะัะพะฟัััะธัั (ัะถะต ัััะฐะฝะพะฒะปะตะฝะพ)     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### ะัะธะผะตั ะผะฐัะบะตัะฐ

```json
{
  "java_home": "C:\\Program Files\\Java\\jdk-17",
  "fonts_installed": [
    "JetBrainsMono-Regular.ttf",
    "FiraCode-Regular.ttf"
  ],
  "platform": "Windows",
  "timestamp": "1701350400.0"
}
```

**ะะฐัะตะผ ััะพ ะฝัะถะฝะพ?**

- PlantUML **ะฝะต ะฒะธะดะธั** ััะธััั ะธะท `asset/fonts/` ะฑะตะท ัััะฐะฝะพะฒะบะธ ะฒ JRE
- Windows API `AddFontResourceExW` ัะฐะฑะพัะฐะตั ัะพะปัะบะพ ะดะปั ัะตะบััะตะณะพ ะฟัะพัะตััะฐ, ะฝะพ ะฝะต ะดะปั ะดะพัะตัะฝะตะณะพ Java ะฟัะพัะตััะฐ
- ะะพะฟะธัะพะฒะฐะฝะธะต ะฒ JRE โ ะตะดะธะฝััะฒะตะฝะฝัะน ะบัะพัั-ะฟะปะฐััะพัะผะตะฝะฝัะน ัะฟะพัะพะฑ

---

## 3. ะกะธััะตะผะฐ ัะตะผ PlantUML

### ะััะธัะตะบัััะฐ

```
User: theme="dark_gold"
    โ
diagram_renderer._prepare_diagram_code()
    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. ะัะพะฒะตัะบะฐ ัััะตััะฒะพะฒะฐะฝะธั ัะตะผั        โ
โ    Path("asset/themes/dark_gold.puml") โ
โ                                        โ
โ 2. ะััะฐะฒะบะฐ ะดะธัะตะบัะธะฒั ะฒะบะปััะตะฝะธั        โ
โ    !include asset/themes/dark_gold.pumlโ
โ    โ ะะพะฑะฐะฒะปัะตััั ะะะะะ @startuml       โ
โ                                        โ
โ 3. ะะพะฑะฐะฒะปะตะฝะธะต Smetana (ะฝะพะฒัะน ะดะฒะธะถะพะบ)  โ
โ    !pragma layout smetana              โ
โ    โ ะฃะปัััะฐะตั ะบะฐัะตััะฒะพ ะฐะฒัะพะปะตะนะฐััะฐ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะัะธะผะตั ะฟัะตะพะฑัะฐะทะพะฒะฐะฝะธั ะบะพะดะฐ

**ะัะพะดะฝะพะน ะบะพะด:**

```plantuml
@startuml
component "API" <<Adapter>>
@enduml
```

**ะะพัะปะต ะพะฑัะฐะฑะพัะบะธ `_prepare_diagram_code()`:**

```plantuml
@startuml
!pragma layout smetana
!include asset/themes/dark_gold.puml

component "API" <<Adapter>>
@enduml
```

**ะะปััะตะฒะพะต ะพัะปะธัะธะต:** PlantUML ัะฝะฐัะฐะปะฐ ัะธัะฐะตั ััะธะปะธ ะธะท ัะตะผั, **ะฟะพัะพะผ** ะฟัะธะผะตะฝัะตั ะธั ะบ ะบะพะผะฟะพะฝะตะฝัะฐะผ ั ััะตัะตะพัะธะฟะฐะผะธ.

---

## 4. ะะฑัะฐะฑะพัะบะฐ ะธะทะพะฑัะฐะถะตะฝะธะน (image_utils)

### ะฃะฝะธะฒะตััะฐะปัะฝัะน Pipeline

```python
# 1. ะััะพัะฝะธะบ: Pillow Image (ะธะท Pygments ะธะปะธ PlantUML)
image: PIL.Image.Image

# 2. ะะฟัะธะพะฝะฐะปัะฝะพ: ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต
if scale_factor != 1.0:
    image = resize_image(image, scale_factor)

# 3. ะกะพััะฐะฝะตะฝะธะต ั ะพะฟัะธะผะธะทะฐัะธะตะน
save_image(
    image,
    output_path="result.webp",
    format="webp",
    quality=90  # ะะฐะปะฐะฝั ะบะฐัะตััะฒะพ/ัะฐะทะผะตั
)
```

### ะะฟัะธะผะธะทะฐัะธะธ

#### WebP (ัะตะบะพะผะตะฝะดัะตััั)

- **ะะตัะพะด:** `lossless=False` + ะบะฐัะตััะฒะพ 90
- **ะะตะทัะปััะฐั:** ะะฐะทะผะตั ัะฐะนะปะฐ ะฝะฐ 30% ะผะตะฝััะต PNG ะฟัะธ ัะพะผ ะถะต ะฒะธะทัะฐะปัะฝะพะผ ะบะฐัะตััะฒะต

#### PNG

- **ะะตัะพะด:** `optimize=True` + `compress_level=9`
- **ะะตะทัะปััะฐั:** ะะตะดะปะตะฝะฝะตะต, ะฝะพ ะฑะตะท ะฟะพัะตัะธ ะบะฐัะตััะฒะฐ

#### JPEG

- **ะะฒัะพะบะพะฝะฒะตััะธั RGBA โ RGB** (JPEG ะฝะต ะฟะพะดะดะตัะถะธะฒะฐะตั ะฐะปััะฐ-ะบะฐะฝะฐะป)
- **ะะฐัะตััะฒะพ:** 92 (ะฑะฐะปะฐะฝั ะดะปั ะบะพะดะฐ ั ะผะตะปะบะธะผ ัะตะบััะพะผ)

---

## 5. ะฃะฟัะฐะฒะปะตะฝะธะต ะณะฐะนะดะฐะผะธ (guide_manager)

### ะะฐะทะฝะฐัะตะฝะธะต

ะัะตะดะพััะฐะฒะปัะตั **AI-ะฐะณะตะฝัะฐะผ** ะบัะฐัะบะธะต/ะฟะพะปะฝัะต ะธะฝััััะบัะธะธ ะฟะพ PlantUML ัะธะฝัะฐะบัะธัั ะฟััะผะพ ัะตัะตะท MCP ะธะฝััััะผะตะฝั.

### ะััะธัะตะบัััะฐ

```
doc/plantuml_guides/
โโโ index.json           # ะะตัะฐะดะฐะฝะฝัะต ะฒัะตั ะณะฐะนะดะพะฒ
โโโ class_diagram.md     # Markdown ั ะผะฐัะบะตัะฐะผะธ
โโโ sequence_diagram.md
โโโ themes.md

Markdown ััััะบัััะฐ:
<!-- BRIEF_START -->
ะัะฐัะบะพะต ะพะฟะธัะฐะฝะธะต (500 ัะธะผะฒะพะปะพะฒ)
<!-- BRIEF_END -->

<!-- DETAILED_START -->
ะะพะปะฝะพะต ััะบะพะฒะพะดััะฒะพ (ะฑะตะท ะพะณัะฐะฝะธัะตะฝะธะน)
<!-- DETAILED_END -->
```

### ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฒ MCP

```python
# ะะฝััััะผะตะฝั ะดะปั AI-ะฐะณะตะฝัะฐ
@mcp.tool()
def get_plantuml_guide(diagram_type: str, detail_level: str = "brief"):
    content = get_guide(diagram_type, full=(detail_level == "full"))
    return {"guide": content}
```

**ะะพะปัะทะฐ:** ะะณะตะฝั ะผะพะถะตั ะทะฐะฟัะพัะธัั ะธะฝััััะบัะธั ะฟััะผะพ ะฒะพ ะฒัะตะผั ะดะธะฐะปะพะณะฐ, ะฝะต ะทะฐะณััะถะฐั ะฒะตัั ะณะฐะนะด ะฒ ะฟัะพะผะฟั.

---

## 6. ะะพัะพะบะธ ะดะฐะฝะฝัั

### ะะตะฝะตัะฐัะธั ัะบัะธะฝัะพัะฐ ะบะพะดะฐ (High-level)

```mermaid
graph LR
    A[MCP Tool Call] --> B[server.py]
    B --> C[code_to_image.py]
    C --> D[Pygments Render]
    D --> E[PIL Image]
    E --> F[image_utils.save]
    F --> G[WEBP ัะฐะนะป]
```

### ะะตะฝะตัะฐัะธั ะดะธะฐะณัะฐะผะผั (High-level)

```mermaid
graph TD
    A[MCP Tool Call] --> B[server.py]
    B --> C[diagram_renderer.py]
    C --> D{ะจัะธััั ัััะฐะฝะพะฒะปะตะฝั?}
    D -- ะะตั --> E[font_initializer]
    E --> F[ะะพะฟะธัะพะฒะฐะฝะธะต TTF ะฒ JRE]
    F --> G[Java PlantUML Process]
    D -- ะะฐ --> G
    G --> H[PNG bytes]
    H --> I[PIL Image]
    I --> J[image_utils.save]
    J --> K[PNG/SVG ัะฐะนะป]
```

---

## 7. ะัะพัั-ะฟะปะฐััะพัะผะตะฝะฝะพััั

### Windows

- โ Font injection ัะตัะตะท ะบะพะฟะธัะพะฒะฐะฝะธะต ะฒ JRE (ัะฐะฑะพัะฐะตั)
- โ Subprocess ั UTF-8 ะบะพะดะธัะพะฒะบะพะน
- โ๏ธ ะขัะตะฑัะตััั Java 11+ ะฒ PATH

### macOS

- โ Font injection ัะตัะตะท JRE
- โ Homebrew Java ะฟะพะดะดะตัะถะธะฒะฐะตััั
- โ๏ธ ะะพะบัะผะตะฝัะฐัะธั: `doc/macos_compatibility.md`

### Linux

- โ Font injection ัะตัะตะท JRE
- โ OpenJDK ะธะท ัะตะฟะพะทะธัะพัะธะตะฒ
- โ๏ธ ะขัะตะฑััััั ะฟัะฐะฒะฐ ะฝะฐ ะทะฐะฟะธัั ะฒ `/usr/lib/jvm/.../lib/fonts`

---

## 8. ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

### ะฃะทะบะธะต ะผะตััะฐ

| ะะฟะตัะฐัะธั | ะัะตะผั | ะะฟัะธะผะธะทะฐัะธั |
|----------|-------|-------------|
| PlantUML ัะตะฝะดะตัะธะฝะณ | 1-3 ัะตะบ | ะะตัะธัะพะฒะฐะฝะธะต ัะตะทัะปััะฐัะพะฒ ะฝะต ัะตะฐะปะธะทะพะฒะฐะฝะพ |
| ะะฝัะตะบัะธั ััะธััะพะฒ | 500 ะผั | ะัะฟะพะปะฝัะตััั 1 ัะฐะท, ะทะฐัะตะผ ะฟัะพะฟััะบะฐะตััั |
| Pygments ัะตะฝะดะตัะธะฝะณ | 100-300 ะผั | ะะฐะฒะธัะธั ะพั ะดะปะธะฝั ะบะพะดะฐ |
| ะกะพััะฐะฝะตะฝะธะต WEBP | 50-200 ะผั | ะััััะตะต PNG ะฝะฐ 40% |

### ะะตะบะพะผะตะฝะดะฐัะธะธ

1. **ะะปั ะผะฐััะพะฒะพะน ะณะตะฝะตัะฐัะธะธ:** ะะตะฐะปะธะทะพะฒะฐัั ะบะตั PlantUML ัะตะทัะปััะฐัะพะฒ (ัะตั ะบะพะดะฐ โ ัะฐะนะป)
2. **ะะปั API:** ะัะฟะพะปัะทะพะฒะฐัั ะฐัะธะฝััะพะฝะฝัะต ะทะฐะดะฐัะธ (Celery)
3. **ะะปั ะฟัะตะทะตะฝัะฐัะธะน:** ะะตะฝะตัะธัะพะฒะฐัั ะฒ 4K ะพะดะธะฝ ัะฐะท, ะฟะตัะตะธัะฟะพะปัะทะพะฒะฐัั

---

## 9. ะะตะทะพะฟะฐัะฝะพััั

### PlantUML Code Injection

PlantUML ะฟะพะดะดะตัะถะธะฒะฐะตั `!include` ะดะธัะตะบัะธะฒั, ะบะพัะพััะต ะผะพะณัั ัะธัะฐัั ะปะพะบะฐะปัะฝัะต ัะฐะนะปั:

```plantuml
@startuml
!include /etc/passwd
@enduml
```

**ะะฐัะธัะฐ:** ะ `_prepare_diagram_code()` ะผั **ะทะฐะผะตะฝัะตะผ** ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะน ะบะพะด, ะฒััะฐะฒะปัั ัะพะปัะบะพ ะฑะตะทะพะฟะฐัะฝัะต ะดะธัะตะบัะธะฒั. PlantUML ะทะฐะฟััะบะฐะตััั ั `-failfast2`, ะบะพัะพััะน ะฑะปะพะบะธััะตั ะพะฟะฐัะฝัะต ะพะฟะตัะฐัะธะธ.

### Java Sandbox

PlantUML JAR ะทะฐะฟััะบะฐะตััั **ะฑะตะท** ัะตัะตะฒะพะณะพ ะดะพัััะฟะฐ (`-Dplantuml.security.mode=sandbox` ะฒ ะฑัะดััะธั ะฒะตััะธัั).

---

## 10. ะขะตััะธัะพะฒะฐะฝะธะต

### ะกัััะบัััะฐ ัะตััะพะฒ

```
tests/
โโโ test_code_to_image.py     # (TODO) ะกะบัะธะฝัะพัั ะบะพะดะฐ
โโโ test_diagram_renderer.py  # PlantUML ัะตะฝะดะตัะธะฝะณ
โโโ test_font_*.py            # ะะฝัะตะบัะธั ััะธััะพะฒ
โโโ test_guide_manager.py     # ะะฐะนะดั
โโโ test_image_utils.py       # ะะฑัะฐะฑะพัะบะฐ ะธะทะพะฑัะฐะถะตะฝะธะน
```

### ะะฐะฟััะบ

```bash
pytest tests/ -v              # ะัะต ัะตััั
pytest tests/test_image_utils.py -v  # ะะดะธะฝ ะผะพะดัะปั
pytest -k "font" -v           # ะขะพะปัะบะพ font-ัะตััั
```

---

## ะะพะปะตะทะฝัะต ัััะปะบะธ

- [PlantUML ะพัะธัะธะฐะปัะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั](https://plantuml.com/ru/)
- [Pygments ะดะพะบัะผะตะฝัะฐัะธั](https://pygments.org/docs/)
- [Pillow ััะบะพะฒะพะดััะฒะพ](https://pillow.readthedocs.io/)
- [FastMCP ะดะพะบัะผะตะฝัะฐัะธั](https://github.com/jlowin/fastmcp)

---

**ะะพะฟัะพัั ะฟะพ ะฐััะธัะตะบัััะต?** ะะทััะธัะต ะบะพะด ะผะพะดัะปะตะน ะธะปะธ ะพัะบัะพะนัะต Issue ะฒ ัะตะฟะพะทะธัะพัะธะธ.
